# 📗 分析层能力详解 - 从探索到治理

> **完整的数据分析与洞察平台** - Contour → Quiver → Lineage → Geospatial

**对应工具编号**：01, 10-13, 06, 56
**适合角色**：数据分析师、商业分析师、数据科学家
**学习周期**：5-7天

---

## 📑 目录

1. [第1章：Contour - 路径式分析](#第1章-contour---路径式分析)
2. [第2章：Quiver - 时序分析与可视化](#第2章-quiver---时序分析与可视化)
3. [第3章：Data Lineage - 数据谱系与治理](#第3章-data-lineage---数据谱系与治理)
4. [第4章：Geospatial - 地理空间分析](#第4章-geospatial---地理空间分析)
5. [实战工作流](#实战工作流)
6. [最佳实践](#最佳实践)

---

## 第1章：Contour - 路径式分析

### 1.1 核心概念

**Contour** 是 Foundry 的**即时大规模数据分析引擎**，特点：

- **路径（Paths）**：组织分析的逻辑单元
- **卡板（Boards）**：展示数据或转换数据的组件
- **大规模数据处理**：支持 100M+ 行数据实时查询
- **参数化分析**：通过动态参数使分析交互化

### 1.2 Contour 的基本结构

```
Contour 应用
├─ 路径 1：销售分析
│  ├─ 卡板 1：订单总体趋势
│  ├─ 卡板 2：地区对标
│  └─ 卡板 3：客户分析
├─ 路径 2：库存分析
│  ├─ 卡板 1：库存水位
│  └─ 卡板 2：周转率分析
└─ 路径 3：财务分析
   ├─ 卡板 1：收入分解
   └─ 卡板 2：成本控制
```

### 1.3 实战案例：构建零售销售分析应用

**业务背景**：零售 CFO 需要"实时掌握各门店销售状况"，包括趋势、对标、风险预警

```
【第1步】创建 Contour 应用
├─ 登录 Foundry → Applications → Contour
├─ 点击"Create New Analysis"
├─ 输入名称："Retail Sales Analytics"
├─ 选择数据源：orders_final 数据集（来自 Pipeline）
└─ 进入编辑界面

【第2步】创建路径与卡板架构
├─ 创建路径1："Overview（概览）"
│  ├─ 卡板1-1："Total KPIs（总体指标）"
│  ├─ 卡板1-2："Daily Trend（日销售趋势）"
│  └─ 卡板1-3："Top Products（热销产品）"
├─ 创建路径2："Store Comparison（门店对标）"
│  ├─ 卡板2-1："Store Performance（门店业绩）"
│  ├─ 卡板2-2："Sales per Store（门店销售额）"
│  └─ 卡板2-3："Growth Rate（同环比）"
├─ 创建路径3："Risk Alert（风险预警）"
│  ├─ 卡板3-1："Underperforming Stores（低迷门店）"
│  └─ 卡板3-2："Issue Tracker（问题追踪）"
└─ 创建路径4："Deep Dive（深度分析）"
   ├─ 卡板4-1："Customer Segmentation（客户分层）"
   └─ 卡板4-2："Product Category（产品分类）"

【第3步】构建"Overview"路径下的 KPI 卡板
├─ 选择卡板1-1："Total KPIs"
├─ 添加第一个指标卡
│  ├─ 指标名："Total Revenue（总收入）"
│  ├─ 配置聚合：
│  │  ├─ 数据源：orders_final
│  │  ├─ 聚合函数：SUM(order_total)
│  │  ├─ 过滤条件：WHERE order_date >= '2024-01-01'
│  │  └─ 显示值：$1,234,567
│  ├─ 添加对比：
│  │  ├─ 上月同期：$1,150,000
│  │  ├─ 增长率：+7.3%（用绿色显示）
│  │  └─ 目标进度：105% 完成
│  └─ 可视化风格：大数字 + 箭头指示
│
├─ 添加第二个指标卡
│  ├─ 指标名："Total Orders（总订单数）"
│  ├─ 聚合：COUNT(DISTINCT order_id)
│  ├─ 显示值：45,230 笔
│  ├─ 对比：↑ 12% vs 上月
│  └─ 可视化风格：数字 + 小图表
│
├─ 添加第三个指标卡
│  ├─ 指标名："Avg Order Value（平均订单值）"
│  ├─ 聚合：AVG(order_total)
│  ├─ 显示值：$27.28
│  ├─ 对比：↓ 3.2% vs 上月
│  └─ 颜色提示：黄色（需关注）
│
└─ 添加第四个指标卡
   ├─ 指标名："Total Customers（客户数）"
   ├─ 聚合：COUNT(DISTINCT customer_id)
   ├─ 显示值：8,234
   ├─ 新增客户：+532（周环比）
   └─ 可视化：数字 + 百分比

【第4步】构建"Day Trend"卡板
├─ 选择卡板1-2："Daily Trend"
├─ 配置时间序列图表
│  ├─ 图表类型：Line Chart（折线图）
│  ├─ 数据配置：
│  │  ├─ X轴：order_date（日期）
│  │  ├─ Y轴：SUM(order_total)（销售额）
│  │  └─ 粒度：每日
│  ├─ 添加两条线对比：
│  │  ├─ 线1（蓝色）：当前周销售
│  │  │  └─ 数据：WHERE order_date BETWEEN '2024-01-15' AND '2024-01-21'
│  │  ├─ 线2（灰色虚线）：上周销售
│  │  │  └─ 数据：WHERE order_date BETWEEN '2024-01-08' AND '2024-01-14'
│  │  └─ 互动：鼠标悬停显示具体数值
│  ├─ 添加趋势线：
│  │  ├─ 类型：Moving Average（移动平均）
│  │  ├─ 窗口：7 日
│  │  └─ 颜色：红色虚线
│  └─ 添加基准线：
│     ├─ 值：平均日销售额
│     └─ 颜色：绿色虚线

【第5步】构建"Store Comparison"路径
├─ 选择卡板2-1："Store Performance"
├─ 配置表格组件
│  ├─ 表格类型：Rank Table（排名表）
│  ├─ 数据配置：
│  │  ├─ 分组维度：store_id, store_name, region
│  │  ├─ 聚合指标：
│  │  │  ├─ SUM(order_total) as 销售额
│  │  │  ├─ COUNT(*) as 订单数
│  │  │  ├─ AVG(order_total) as 平均订单值
│  │  │  ├─ ROUND(SUM(order_total) / target * 100, 2) as 目标完成度%
│  │  │  └─ LAG(SUM(order_total)) OVER (ORDER BY ...) as 上月销售
│  │  ├─ 排序：按销售额降序
│  │  └─ 行数：显示前 50 个门店
│  ├─ 条件格式化：
│  │  ├─ 销售额：色阶（最低红色 → 最高绿色）
│  │  ├─ 完成度%：
│  │  │  ├─ >= 100% → 绿色背景
│  │  │  ├─ 80-99% → 黄色背景
│  │  │  └─ < 80% → 红色背景
│  │  ├─ 排名：用奖牌符号标记 (🥇 🥈 🥉)
│  │  └─ 增长指标：用箭头 (↑ ↓) 标记
│  └─ 交互功能：
│     ├─ 点击表格行 → 下钻到该门店详情
│     ├─ 点击列标题 → 排序
│     └─ 导出为 Excel

【第6步】构建"Risk Alert"路径
├─ 选择卡板3-1："Underperforming Stores"
├─ 配置警告面板
│  ├─ 数据源配置：
│  │  ├─ 筛选条件：完成度 < 80% 或 环比 < -10%
│  │  ├─ 风险等级：
│  │  │  ├─ 🔴 严重：完成度 < 60%
│  │  │  ├─ 🟡 中度：完成度 60-80%
│  │  │  └─ 🟢 轻微：环比 < -5%
│  │  └─ 排序：按风险等级
│  ├─ 警告卡片显示：
│  │  ├─ 门店名称
│  │  ├─ 当前销售额
│  │  ├─ 目标值
│  │  ├─ 完成度%
│  │  ├─ 主要问题（自动生成）
│  │  │  ├─ "订单数下降 25%"
│  │  │  ├─ "平均客单价下降 15%"
│  │  │  └─ "新客获取下降 30%"
│  │  └─ 建议行动
│  │     ├─ "加强门店促销"
│  │     ├─ "审查产品配置"
│  │     └─ "联系区域经理"
│  └─ 卡片操作：
│     ├─ 点击"Investigate" → 跳转到详情
│     ├─ 点击"Create Issue" → 创建问题追踪
│     └─ 点击"Send Alert" → 通知相关人员

【第7步】添加交互参数
├─ 创建参数1："Date Range（日期范围）"
│  ├─ 类型：Date Picker
│  ├─ 默认值：最近 30 天
│  ├─ 应用到：所有卡板的时间过滤
│  └─ 影响：所有数据自动刷新
├─ 创建参数2："Region（地区）"
│  ├─ 类型：Dropdown
│  ├─ 选项：['All（全部）', '北区', '南区', '东区', '西区']
│  ├─ 默认值：'All'
│  ├─ 应用到：表格、对标卡板
│  └─ 过滤条件：WHERE region = $Region OR $Region = 'All'
└─ 创建参数3："Store Category（门店类型）"
   ├─ 类型：Multi-Select
   ├─ 选项：['直营店', '加盟店', '线上自提', '旗舰店']
   ├─ 默认值：全选
   ├─ 应用到：所有卡板
   └─ 过滤条件：WHERE store_type IN ($StoreCategory)

【第8步】发布与共享
├─ 点击"Save"保存分析
├─ 点击"Publish"发布版本
│  ├─ 输入版本号：v1.0
│  ├─ 发布说明："Initial launch of Retail Sales Analytics"
│  └─ 发布状态：Live
├─ 配置权限：
│  ├─ 编辑者：Sales Leadership Team
│  ├─ 查看者：所有员工
│  └─ 数据访问权限：按部门级联
└─ 分享选项：
   ├─ 生成公共链接
   ├─ 添加到收藏夹
   ├─ 内嵌到网页
   └─ 导出为 PDF 报告

【第9步】配置自动刷新与推送
├─ 设置数据刷新：
│  ├─ 刷新频率：每 4 小时
│  ├─ 高峰时段：每小时 (9:00-18:00)
│  └─ 非高峰：每日一次 (21:00)
├─ 设置推送任务：
│  ├─ 每日 08:00 发送昨日报告
│  │  ├─ 收件人：销售管理层
│  │  ├─ 内容：KPI 摘要 + 风险警告
│  │  └─ 格式：HTML 邮件 + PDF 附件
│  ├─ 每周一 09:00 发送周报
│  │  ├─ 收件人：全体销售人员
│  │  ├─ 内容：排名对标 + 最佳实践
│  │  └─ 格式：HTML 邮件
│  └─ 异常告警（实时）
│     ├─ 触发条件：日销售额 < 平均 -3σ
│     ├─ 动作：Slack 通知 + 邮件告警
│     └─ 收件人：门店经理 + 区域经理

【实际效果】

最终用户界面（截图示意）：
┌─────────────────────────────────────────┐
│ 📊 零售销售分析                          │
├─────────────────────────────────────────┤
│ 📅 日期: [2024-01-01 ▼] ~ [2024-01-16] │
│ 🌍 地区: [All ▼]                       │
│ 🏪 门店: [全选 ▼]                       │
├─────────────────────────────────────────┤
│ ◆ 总收入          ◆ 总订单数            │
│ $1,234,567      45,230 笔              │
│ ↑ +7.3%         ↑ +12%                 │
│                                         │
│ ◆ 平均订单值      ◆ 客户数              │
│ $27.28          8,234                  │
│ ↓ -3.2%         ↑ +6.4%                │
├─────────────────────────────────────────┤
│ 📈 日销售趋势                            │
│      ├─────────────────────────────┤    │
│      │                             │    │
│   $50K ├─ ╱╲      当前周           │    │
│        │╱  ╲╱╲   ─────            │    │
│   $40K ├─╱    ╲ ╱ 上周(虚线)      │    │
│        │      ╲╱╲                 │    │
│   $30K ├──────────────────────────┤    │
│        └──一 二 三 四 五 六 日──    │    │
│                                         │
├─────────────────────────────────────────┤
│ 🏆 门店排名Top 5                         │
│ ┌────┬────────┬──────┬───────┐        │
│ │排名│门店    │销售额│完成度%│        │
│ ├────┼────────┼──────┼───────┤        │
│ │🥇 1│南区1号 │$89K  │105%🟢 │        │
│ │🥈 2│北区2号 │$78K  │98% 🟡 │        │
│ │🥉 3│东区1号 │$65K  │82%🟡  │        │
│ ├────┼────────┼──────┼───────┤        │
│ │4   │西区3号 │$52K  │65%🔴  │        │
│ │5   │中心1号 │$48K  │60%🔴  │        │
│ └────┴────────┴──────┴───────┘        │
│                                         │
│ ⚠️ 风险预警：2 个门店完成度 < 70%     │
│ [View Details]                          │
│                                         │
├─────────────────────────────────────────┤
│ 更新于: 2024-01-16 14:30 UTC            │
│ [刷新] [导出] [分享] [更多]             │
└─────────────────────────────────────────┘

预期时间：2-4 小时
```

### 1.4 高级特性

| 特性 | 说明 | 使用场景 |
|------|------|--------|
| **钻取分析** | 点击图表 → 下钻到详情 | 从总体指标 → 地区 → 门店 |
| **参数化** | 动态参数 → 交互式分析 | 让非技术用户自助分析 |
| **条件格式** | 自定义颜色、图标 | 直观展示数据状态 |
| **关联过滤** | 点击一个元素 → 影响其他 | 多卡板联动分析 |
| **性能优化** | 预聚合、缓存、分页 | 100M+ 行数据秒级响应 |

---

## 第2章：Quiver - 时序分析与可视化

### 2.1 核心概念

**Quiver** 是 Foundry 的**时序分析与可视化专家**，支持：

- **时序函数**：聚合、窗口函数、移动平均
- **多轴图表**：同时展示不同量纲的指标
- **交互式仪表板**：参数化、下钻、联动
- **可视化函数**：封装分析逻辑，供他人复用

### 2.2 实战案例：财务收入趋势分析

**业务背景**：财务部需要"月度收入分析"，包括趋势、同环比、预测

```
【第1步】创建 Quiver Visual Function
├─ 登录 Foundry → Analytics → Quiver
├─ 点击"Create Visual Function"
├─ 输入名称："Monthly Revenue Analysis"
├─ 选择数据源：orders_final 数据集
└─ 进入配置界面

【第2步】定义输入与输出
├─ 定义输入：
│  ├─ Input 1："orders"（订单数据集）
│  │  └─ 约束：需包含 order_date, order_total, order_status
│  ├─ Input 2："targets"（目标数据，可选）
│  │  └─ 约束：需包含 month, target_revenue
│  └─ Input 3："parameters"
│     ├─ year_filter：分析年份（默认当前年）
│     └─ include_forecast：是否显示预测（默认 True）
├─ 定义输出：
│  ├─ Output 1："revenue_trend"（时序数据）
│  │  ├─ 字段：month, revenue, mom_growth%, yoy_growth%
│  │  └─ 用途：用于图表渲染
│  ├─ Output 2："revenue_summary"（汇总统计）
│  │  ├─ 字段：total_revenue, avg_monthly, max_month, min_month
│  │  └─ 用途：显示在 KPI 卡片
│  └─ Output 3："anomalies"（异常检测）
│     ├─ 字段：month, revenue, expected, deviation_sigma
│     └─ 用途：风险预警

【第3步】配置数据聚合
├─ 时间粒度："按月聚合"（Month）
├─ 聚合函数：
│  ├─ 主指标：SUM(order_total) as revenue
│  ├─ 辅助：COUNT(*) as order_count, AVG(order_total) as aov
│  └─ 其他：COUNT(DISTINCT customer_id) as unique_customers
├─ 过滤条件：
│  ├─ WHERE order_status IN ('completed', 'delivered')
│  ├─ WHERE YEAR(order_date) = $year_filter
│  └─ WHERE order_total > 0 (排除异常数据)
└─ 排序：按 month ASC

【第4步】添加计算指标
├─ 环比增长率（MoM）：
│  ├─ 公式：(current_month_revenue - prev_month_revenue) / prev_month_revenue * 100
│  ├─ 实现：LAG(revenue, 1) OVER (ORDER BY month)
│  ├─ 别名：mom_growth_pct
│  └─ 显示：带箭头，正数绿色，负数红色
├─ 同比增长率（YoY）：
│  ├─ 公式：(current_month - same_month_last_year) / same_month_last_year * 100
│  ├─ 实现：LAG(revenue, 12) OVER (ORDER BY month)
│  ├─ 别名：yoy_growth_pct
│  └─ 显示：同环比
├─ 目标完成度：
│  ├─ 公式：revenue / target_revenue * 100
│  ├─ 数据源：JOIN targets 表
│  ├─ 别名：target_completion_pct
│  └─ 显示：进度条
└─ 累积收入：
   ├─ 公式：SUM(revenue) OVER (ORDER BY month ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
   ├─ 别名：cumulative_revenue
   └─ 显示：辅助线

【第5步】配置异常检测
├─ 方法1：三西格玛规则
│  ├─ 计算平均值 & 标准差：
│  │  ├─ mean_revenue = AVG(revenue) OVER (ORDER BY month ROWS BETWEEN 12 PRECEDING AND CURRENT ROW)
│  │  ├─ stddev_revenue = STDDEV(revenue) OVER (ORDER BY month ROWS BETWEEN 12 PRECEDING AND CURRENT ROW)
│  │  └─ deviation_sigma = (revenue - mean_revenue) / stddev_revenue
│  ├─ 异常标记：ABS(deviation_sigma) > 3
│  └─ 可视化：圆点标记在图表上
├─ 方法2：同环比阈值
│  ├─ 触发条件：环比 < -20% OR 环比 > +50%
│  ├─ 风险等级：判断是否异常
│  └─ 可视化：带颜色的警告标记
└─ 方法3：目标偏离
   ├─ 触发条件：完成度 < 80%
   ├─ 预警优先级：优先显示
   └─ 可视化：红色背景

【第6步】创建可视化
├─ 图表1：双轴时序图
│  ├─ 图表类型：Line + Bar Combo
│  ├─ 左Y轴（线图，蓝色）：revenue（万元）
│  ├─ 右Y轴（柱子，灰色）：order_count（笔数）
│  ├─ X轴（底部）：month（年-月）
│  ├─ 数据系列：
│  │  ├─ 主线（蓝线）：当年收入
│  │  ├─ 虚线（灰线）：去年同期（对比）
│  │  ├─ 趋势线（红虚线）：3个月移动平均
│  │  ├─ 预测线（绿虚线）：向后推 3 个月
│  │  └─ 基准线（黄虚线）：目标值
│  └─ 交互：
│     ├─ 点击月份 → 显示详情
│     ├─ 鼠标悬停 → Tooltip
│     └─ 拖拽范围 → 放大/缩小
│
├─ 图表2：增长率图
│  ├─ 图表类型：Bar Chart（柱状图）
│  ├─ X轴：month
│  ├─ Y轴：growth_rate（%）
│  ├─ 颜色编码：
│  │  ├─ > 0%：绿色（正增长）
│  │  ├─ -10% ~ 0%：黄色（小幅下降）
│  │  └─ < -10%：红色（严重下降）
│  ├─ 参考线：0（基准）
│  └─ 标签：每个柱子顶部显示具体百分比
│
├─ 图表3：热力图（可选）
│  ├─ 图表类型：Heatmap
│  ├─ X轴：Month（月份）
│  ├─ Y轴：Year（年份）
│  ├─ 值：Revenue（金额）
│  ├─ 颜色梯度：
│  │  ├─ 最低值：深红色（最低收入）
│  │  ├─ 中值：白色
│  │  └─ 最高值：深绿色（最高收入）
│  └─ 用途：快速识别高低收入月份的模式
│
└─ 图表4：统计汇总表
   ├─ 表格类型：Key Metrics
   ├─ 显示字段：
   │  ├─ 总收入：SUM(revenue)
   │  ├─ 平均月收入：AVG(revenue)
   │  ├─ 最高月份：MAX(revenue) 对应的月份
   │  ├─ 最低月份：MIN(revenue) 对应的月份
   │  ├─ 增长率：(last_month - first_month) / first_month * 100
   │  ├─ 完成率：AVG(target_completion_pct)
   │  └─ 异常月份数：COUNT(*) WHERE ABS(deviation_sigma) > 3
   └─ 格式化：
      ├─ 货币值：3 位小数 + 货币符号
      ├─ 百分比：2 位小数 + % 符号
      └─ 字数：超过 1M 显示 "1.2M"

【第7步】发布为可复用函数
├─ 点击"Save as Visual Function"
├─ 输入函数元数据：
│  ├─ 名称："Monthly Revenue Analysis"
│  ├─ 描述："财务部月度收入分析，包含趋势、同环比、预测"
│  ├─ 版本：v1.0
│  ├─ 标签：["finance", "monthly", "trend"]
│  └─ 作者：财务分析师
├─ 发布：
│  ├─ 可见性："Internal（内部共享）"
│  ├─ 权限："Finance Team（编辑），All Users（查看）"
│  └─ 文档："在 Notepad 中创建使用说明"
└─ 版本控制：
   └─ 自动与 Git 同步

【第8步】在其他分析中复用
├─ 其他分析师可在 Contour 中引用此函数
├─ 直接调用无需重复开发
├─ 动态参数支持：
│  ├─ 选择不同年份进行对比
│  ├─ 切换预测算法
│  └─ 调整异常检测灵敏度
└─ 结果自动更新：源数据变化 → 引用自动刷新

【实际效果】

图表界面（示意）：
┌─────────────────────────────────────┐
│ 📈 月度收入分析 - 2024               │
├─────────────────────────────────────┤
│ 年份: [2024 ▼] 预测: [✓ 包含]      │
├─────────────────────────────────────┤
│
│ 收入趋势（万元）               环比 %
│      ├─────────────────────────────┤
│ 140 │                      ╱  ┃50%
│     │    ╱╲    ╱╲         ╱  ╱╲┃
│ 120 │   ╱  ╲  ╱  ╲   ╱╲  ╱  ╱  ╲  ┃20%
│     │  ╱    ╲╱    ╲ ╱  ╲╱  ╱    ╲ ┃
│ 100 │─╱──────────  ╲────  ───────  │0%
│     │              ╲  ╱
│ 80  │               ╲╱    ┃-20%
│     │                   ┃
│     └─ 1  2  3  4  5  6  7  8  9 10 ┃
│     ┃ 当年 ─ 去年 ∿ 预测 ─ 目标 ┃
│
│ 增长率分析
│ ┌────┬──────┬─────────┐
│ │月份│环比% │同比%   │
│ ├────┼──────┼─────────┤
│ │1月 │ N/A  │ +12%↑  │
│ │2月 │+18%↑ │ +8%↑   │
│ │3月 │-12%↓ │ -5%↓   │
│ │...│ ...  │ ...     │
│ └────┴──────┴─────────┘
│
│ 📊 关键指标
│ 总收入: $1.45M | 平均月: $120.8K
│ 完成率: 95.3% | 异常: 1个月份
│
│ [导出 CSV] [分享] [编辑]
└─────────────────────────────────────┘

预期时间：2-3 小时
```

### 2.3 高级功能：预测与异常检测

```
【预测功能】

算法选项：
1. 线性回归：适合稳定增长的指标
2. 季节性分解：捕捉周期性模式
3. ARIMA：时间序列标准方法
4. Prophet：处理节假日与数据异常

使用示例：
├─ 过去 24 个月数据 → 拟合模型
├─ 向前预测 3 个月
├─ 显示预测区间（置信度 95%）
└─ 月环比对比：预测 vs 实际

【异常检测】

方法1：统计异常（三西格玛）
└─ 超过 ±3σ 的值标记为异常

方法2：动态阈值
├─ 学习历史 12 个月的模式
├─ 设定上下限
└─ 超过限值的月份报警

方法3：变化率异常
├─ 环比变化 > 30% → 报警
├─ 同比变化 > 50% → 报警
└─ 连续 3 个月下降 → 报警
```

---

## 第3章：Data Lineage - 数据谱系与治理

### 3.1 核心概念

**Data Lineage** 提供**完整的数据血缘追踪**：

- **数据源头**：追踪数据从哪里来
- **转换过程**：每一步的处理逻辑
- **数据流向**：最后用在哪里
- **质量管理**：检测数据问题并溯源

### 3.2 实战案例：订单数据的完整生命周期

```
【数据源】
Snowflake(ORDERS)
       │
       ▼
【数据连接】Data Connection
       │
       └─ Sync 规则：增量，基于 UPDATED_AT
       │
       ▼
【Foundry 数据集】orders_raw
       │
       ▼
【Pipeline 处理】Pipeline Builder
       │
       ├─ 步骤1：过滤
       │  └─ WHERE order_status != 'cancelled'
       │
       ├─ 步骤2：JOIN
       │  └─ LEFT JOIN customers_raw ON customer_id
       │
       ├─ 步骤3：聚合与派生列
       │  ├─ 计算: order_priority, season, ...
       │  └─ 输出: orders_processed
       │
       ▼
【本体对象】Ontology: Order
       │
       ├─ 属性：order_id, customer_id, amount, priority
       ├─ 关系：Customer(1:M), Products(M:M)
       └─ 操作：Assign, Cancel, Complete
       │
       ▼
【应用使用】Workshop + Contour + Notepad
       │
       ├─ Workshop：Order Management App
       ├─ Contour：Sales Analytics
       ├─ Notepad：Weekly Report
       └─ Object Explorer：Order 查询
       │
       ▼
【AI 决策】AIP Agents
       │
       └─ Agent：订单智能分配
          └─ 查询 Order 对象 → 执行 Assign → 记录
```

### 3.3 查看与使用 Lineage

```
【第1步】打开 Data Lineage
├─ 登录 Foundry → Govern → Data Lineage
├─ 或从任何数据集 → 右键 → "View Lineage"
└─ 进入谱系可视化界面

【第2步】查看上游（数据从哪来）
├─ 展开"Upstream"分支
├─ 看到完整的源头路径：
│  ├─ 原始系统（Snowflake）
│  ├─ 数据连接（Data Connection）
│  ├─ 同步过程（Sync Job）
│  ├─ Pipeline 转换
│  └─ 本体映射
└─ 点击每一步可查看详情

【第3步】查看下游（数据用在哪）
├─ 展开"Downstream"分支
├─ 看到所有使用此数据的应用：
│  ├─ 应用1：Order Management（Workshop）
│  ├─ 应用2：Sales Analytics（Contour）
│  ├─ 应用3：Weekly Report（Notepad）
│  ├─ 应用4：AI Agent（自动化）
│  └─ 应用5：API 端点（外部系统）
└─ 点击可跳转到具体应用

【第4步】检查数据质量
├─ 选择某个节点（如 Pipeline 处理步骤）
├─ 查看"Data Health"面板
│  ├─ 行数变化：输入 10M → 输出 9.8M (-2%)
│  ├─ 空值检查：NULL 占比 0.1%
│  ├─ 重复检查：重复 ID 数 0
│  ├─ 范围检查：金额范围 [0, 1M] ✓
│  ├─ 最后更新：2024-01-16 08:00
│  └─ 同步状态：✅ 成功
├─ 如有问题：
│  ├─ 点击"Alert"查看异常
│  ├─ 点击"Create Issue"创建问题单
│  └─ 分配给数据工程师
└─ 质量评分：可视化展示

【第5步】追踪影响范围
├─ 需求：某个源表数据异常，影响有多大？
├─ 操作：
│  ├─ 选择该源表
│  ├─ 展开"Downstream"
│  ├─ 系统自动计算依赖链
│  ├─ 显示：所有受影响的应用、报告、用户
│  └─ 结果：27 个应用、15 个报告、2000+ 用户
├─ 风险评估：
│  ├─ 高优先级应用（关键业务）：5 个
│  ├─ 中优先级应用：10 个
│  └─ 低优先级应用：12 个
└─ 推荐行动：
   ├─ 立即修复关键应用的数据源
   ├─ 2 小时内修复中优先级
   └─ 4 小时内修复其他

【第6步】版本历史与变更
├─ 点击"History"查看时间轴
├─ 时间轴显示：
│  ├─ 2024-01-10：Pipeline 升级，新增字段 priority
│  ├─ 2024-01-08：Data Connection 参数更新
│  ├─ 2024-01-05：本体对象新增关系
│  └─ 2023-12-20：应用 v2.0 上线
├─ 点击每个变更可查看：
│  ├─ 修改内容详情
│  ├─ 修改人与时间
│  ├─ 变更影响分析
│  └─ Rollback 选项（如需要）
└─ 用途：
   ├─ 问题排查：某个应用从什么时候开始出问题？
   ├─ 审计合规：验证数据处理全流程
   └─ 回滚恢复：发现错误后快速恢复

【实际效果】

完整谱系可视化：
┌──────────────────────────────────────────┐
│ 📊 Data Lineage: orders_final             │
├──────────────────────────────────────────┤
│
│                      ┌─ Sales Analytics
│                      │   (Contour)
│                      │
│ Snowflake ──→ DC ──→ Pipeline ──→ Ontology
│ ORDERS       Sync   Process    Order ──→ Workshop
│             (Incr)   (Filter,  (Entity)  (App)
│                      Join,     │
│                      Aggregate)└─ Weekly Report
│                                  (Notepad)
│                                  │
│                                  └─ AIP Agent
│                                     (Automate)
│
│ 📈 数据质量
│ 源数据: 52M rows ✓
│ DC Sync: 51.8M rows (异常: -0.4%, 📋)
│ Pipeline: 51.2M rows (过滤 -1.2%)
│ Ontology: 51.2M rows (完整性 100%)
│
│ ⚠️ 最后同步: 2024-01-16 08:00
│    下一次: 2024-01-16 12:00 (4 小时后)
│
│ [View Details] [History] [Alert] [Report]
│
└──────────────────────────────────────────┘

预期时间：了解与使用 5-10 分钟
```

---

## 第4章：Geospatial - 地理空间分析

### 4.1 核心概念

**Geospatial** 支持**地理位置分析**：

- **地图可视化**：标记、热力图、流向图
- **空间查询**：距离、范围、相交检测
- **轨迹追踪**：实时或历史轨迹回放

### 4.2 实战案例：快递配送路线优化

**业务背景**：物流企业需要"优化配送路线"，减少配送成本

```
【数据准备】
├─ 源数据：Delivery Orders（订单表）
│  ├─ order_id, customer_location, delivery_time, status
│  ├─ 其中 customer_location 为坐标 (lat, lon)
│  └─ 需转化为 Geopoint 类型
├─ Pipeline 中添加转换：
│  ├─ CREATE GEOPOINT(latitude, longitude) as location
│  └─ 输出到本体对象 DeliveryOrder.location
└─ 本体配置：
   ├─ DeliveryOrder 对象
   ├─ location 属性类型：Geopoint
   └─ index: spatial (地理索引)

【第1步】创建地图应用
├─ Workshop → 添加 Map 组件
├─ 配置数据源：DeliveryOrder（通过 ObjectSet）
├─ 配置地理字段：location
├─ 配置标记样式：
│  ├─ 默认标记：蓝色圆点
│  ├─ 已送达：绿色对号
│  ├─ 未送达：红色叉号
│  └─ 进行中：黄色进度圆
└─ 互动：点击标记查看订单详情

【第2步】添加热力图层
├─ 创建热力密度分析
├─ 聚合：按 1km x 1km 网格统计订单数
├─ 颜色梯度：
│  ├─ 0-10 订单：蓝色（稀疏）
│  ├─ 10-50 订单：绿色（中等）
│  ├─ 50-100 订单：黄色（密集）
│  ├─ 100+ 订单：红色（高度密集）
│  └─ 用途：识别配送热点
└─ 可视化：与标记层叠加

【第3步】配送路线规划
├─ 使用"Route Optimization"组件
├─ 输入：
│  ├─ 出发点：配送站地址
│  ├─ 目的地列表：今日待送订单 (100 个)
│  ├─ 约束条件：
│  │  ├─ 时间窗口：每个订单的可送达时间范围
│  │  ├─ 车辆容量：最多 50 个包裹/车
│  │  ├─ 运营时间：08:00-20:00
│  │  └─ 避行区域：堵车热点、禁行区
│  └─ 优化目标：最小化总距离
├─ 算法：
│  ├─ 使用 TSP（旅行商问题）启发式
│  ├─ 地理聚类 → 多车路线
│  └─ 结果：3 条最优路线
└─ 输出：
   ├─ 路线1：47 个订单，总距离 42.3km，预计时间 3h
   ├─ 路线2：32 个订单，总距离 28.1km，预计时间 2h
   ├─ 路线3：21 个订单，总距离 18.9km，预计时间 1.5h
   └─ 总节省：vs 传统路线 节省 15% 距离

【第4步】实时轨迹追踪
├─ 配置数据源：GPS Tracking（实时位置流）
├─ 地图显示：
│  ├─ 现在配送点：闪动蓝色标记
│  ├─ 已完成订单：静止绿点
│  ├─ 轨迹线：已走过的路线 (蓝色虚线)
│  └─ 预计路线：计划的剩余路线 (绿色虚线)
├─ 实时更新：
│  ├─ GPS 每 30 秒上报一次
│  ├─ 地图实时刷新
│  └─ 异常检测（驶离路线 > 500m）
└─ 交互：
   ├─ 点击配送点 → 显示订单详情、客户信息
   ├─ 查询功能 → 搜索特定订单的配送员位置
   └─ 导出 → 生成日报告

【第5步】性能指标计算
├─ 配送成功率：99.2%
├─ 平均配送时间：2h 15min
├─ 人均派送量：52 个/人
├─ 路线效率：98% (vs 理论最优)
├─ 燃油成本：$45/天 (vs $53 之前，节省 15%)
└─ 客户满意度：4.8/5

【实际效果】

实时地图（示意）：
┌─────────────────────────────────┐
│ 📍 配送追踪地图                  │
├─────────────────────────────────┤
│                                 │
│  🗺️ [+] [-] [🧭] [📍] [☰]       │
│                                 │
│     ╔════════════════════════╗  │
│     ║  已送达 ●              ║  │
│     ║  进行中 ●              ║  │
│     ║  待送达 ●              ║  │
│     ╚════════════════════════╝  │
│                                 │
│       ① ---- ③ ---- ②          │
│       ↓       ↓      ↓          │
│      🚗      🚗     🚗          │
│    配送员1  配送员2 配送员3     │
│                                 │
│   配送站                        │
│   ●━━━━━━━━━━━━━━━━━━━→ 目的地 │
│   (已走)  (计划路线)           │
│                                 │
│   热力图: 📊                    │
│   红: 100+ 订单 | 黄: 50-100   │
│   绿: 10-50    | 蓝: <10       │
│                                 │
│ 📊 统计                         │
│ 总订单: 100 | 已送: 78         │
│ 总距离: 89.3 km | 成功率: 99.2%
│                                 │
│ [导出路线] [优化] [查看详情]    │
└─────────────────────────────────┘

预期时间：2-4 小时
```

---

## 实战工作流

### 完整分析流程示例

```
【场景】：零售企业需要"识别低迷门店并采取行动"

【第1天】
├─ 09:00-10:00：使用 Contour 快速查看各门店销售
│  ├─ 发现：西区门店销售环比 -25%，排名垫底
│  └─ 数据源：orders_final (来自 Pipeline)
├─ 10:00-11:00：使用 Quiver 进行时序分析
│  ├─ 深入分析：西区过去 6 个月的趋势
│  ├─ 发现：连续 3 个月下降，趋势恶化
│  └─ 生成：增长率图表与预测
└─ 11:00-12:00：查看 Data Lineage 追踪源头
   ├─ 检查：西区销售数据是否准确
   ├─ 验证：数据质量无问题
   └─ 结论：销售下降属真实情况

【第1天下午】
├─ 14:00-15:30：创建 Notepad 分析报告
│  ├─ 嵌入 Contour 图表
│  ├─ 嵌入 Quiver 时序分析
│  ├─ 添加根本原因分析
│  │  ├─ 假设1：竞争对手开店？查看地理数据
│  │  ├─ 假设2：员工流失？联系 HR
│  │  └─ 假设3：库存不足？查看库存数据
│  └─ 提出 3 个行动建议
└─ 15:30-16:30：分享报告与开会讨论
   ├─ 邀请门店经理、区域经理参与
   ├─ 讨论根本原因
   └─ 制定行动计划

【第2-3天】
├─ 实施行动：
│  ├─ 加强门店促销
│  ├─ 补充库存
│  └─ 考虑人事调整
└─ 监控效果：
   ├─ 在 Contour 中创建动态仪表板
   ├─ 设置每日邮件推送
   ├─ 追踪西区销售是否回升
   └─ 1-2 周后：销售恢复 ✓

【其他应用】
├─ 若需要自动化处理：集成 AIP Agents
│  ├─ 自动检测销售异常
│  ├─ 自动生成报告
│  ├─ 自动发送告警
│  └─ 自动创建工单
└─ 若需要与客户互动：使用 Object Explorer
   ├─ 客户服务团队查询具体订单
   ├─ 了解客户退货原因
   └─ 提高客户满意度
```

---

## 最佳实践

| 最佳实践 | 说明 | 好处 |
|--------|------|------|
| **参数化分析** | 用动态参数 vs 硬编码 | 可复用，便于自助分析 |
| **条件格式化** | 用颜色/图标 vs 数字 | 直观，便于快速洞察 |
| **关联过滤** | 多卡板联动 vs 独立 | 深度分析，交互式体验 |
| **缓存物化** | 预聚合常用指标 | 性能 ↑ 10 倍 |
| **质量监控** | Data Lineage 检查 | 及早发现问题 |
| **定期审查** | 周期性检查报告准确性 | 信任数据 |

---

## 总结与下一步

✅ **Contour**：快速交互式分析
✅ **Quiver**：时序与复杂分析
✅ **Data Lineage**：数据治理与溯源
✅ **Geospatial**：地理空间洞察

### 下一步学习

- 📙 **应用层**：如何将分析结果展示给最终用户
- 📕 **AI层**：如何利用分析数据训练 AI 模型
- 🏗️ **架构设计**：如何设计完整的分析工作流

---

**文档版本**：v1.0
**最后更新**：2024-01-16

