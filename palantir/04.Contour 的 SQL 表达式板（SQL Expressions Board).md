**Contour 的 SQL 表达式板（SQL Expressions Board）** 是 Palantir Foundry 中一个功能强大的低代码工具，允许用户使用 **Spark SQL 表达式** 为分析添加自定义逻辑 [1]。它主要用于派生新列、过滤数据和执行复杂的聚合操作，能够完成其他常规板难以实现的功能 [1]。

以下是关于如何使用该板的详细指南：

### 1. 访问与基本语法
*   **添加方式：** 该板位于“建议的过滤器”、“转换”和“编辑列”菜单下。你也可以使用快捷键 `Ctrl + B` (Windows) 或 `Command + B` (Mac) 直接搜索并添加 [1]。
*   **语法规则：** Contour 使用的是 **Spark SQL** 方言 [2]。
    *   **列名与字符串：** 必须使用 **双引号** 表示列名（如 `"price"`），**单引号** 表示字符串（如 `'online'`） [3]。
    *   **表达式 vs 语句：** 表达式板仅接受 **SQL 表达式**（即语句的一部分），而不接受完整的 SQL 语句（如 `SELECT * FROM...`） [2]。表达式会产生标量值（数字、布尔值、字符串等）或表 [2]。
*   **操作技巧：** 编辑器支持按 `Tab` 接受自动补全建议，并支持使用 `--` 进行代码注释 [3]。

### 2. 核心应用场景
SQL 表达式板在 Contour 中有四种主要用途：
*   **派生新列（Derive New Columns）：** 例如，使用 `upper("point_of_sale")` 将销售点列转为大写，或者使用 `CASE WHEN` 逻辑进行复杂的分类重组 [2, 3]。
*   **替换现有列：** 在派生逻辑的基础上，直接更新原有的列数据 [2]。
*   **过滤数据（Filtering）：** 编写返回布尔值（True 或 False）的表达式。例如，指定某列必须等于另一个复杂的计算值 [4]。
*   **聚合（Aggregations）：** 其行为类似于 SQL 中的 `GROUP BY`。用户可以在顶部指定分组字段（支持多个字段组合），在下方编写聚合表达式（如平均值、方差等） [4, 5]。

### 3. 高级分析能力
*   **窗口函数（Window Functions）：** 允许在不改变数据形状（不减少行数）的情况下进行分组计算 [6]。
    *   例如：`SUM("price") OVER (PARTITION BY "pos" ORDER BY "date" ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)` 可用于计算累计销售额 [6, 7]。
    *   注意：窗口函数的结果无法直接在同一个板内过滤，通常需要先生成新列，再添加一个过滤表达式板 [4, 8]。
*   **两步分析法：** 它可以完成高级统计分析（如 T 检验）。第一步通过聚合板计算均值、方差和行数；第二步使用另一个表达式板根据公式计算最终指标 [9, 10]。

### 4. 参数化与复用
*   **使用参数：** 可以在表达式中通过在名称前加 `$` 符号来引用 **Contour 参数**（例如 `$"Online_Category_Name"`） [11]。这使得分析能够根据用户在仪表盘上的输入动态调整 [11]。
*   **保存表达式库：** 你可以将编写好的复杂表达式保存到 **“已保存表达式库（Saved Expressions Library）”** 中，以便自己或同事未来复用 [11]。
    *   在保存时，需要定义输入参数（如“均值”、“方差”等），未来使用时只需将当前数据集的列映射到这些参数即可 [12]。
    *   常见的保存示例包括：修改后的星期几计算、滚动一周平均值（Rolling Average）或数据归一化（0-100） [12, 13]。

### 5. 注意事项
*   **非确定性行为：** 使用某些函数（如窗口函数中的 `last`）时，如果排序列存在重复值，Contour 会发出警告，提示结果可能由于排序逻辑不唯一而不确定 [8]。
*   **复杂性权衡：** 虽然表达式板可以实现极复杂的统计（如 T 统计量），但在 Foundry 中，对于极高级的统计分析，使用 R 或 Python 的 Code Workbooks 或 Code Workspaces 可能是更高效的选择 [5, 10]。
