在 Palantir Foundry 中，为 AIP Agent 构建**记忆（Memory）**功能意味着使其能够跨越不同的会话（Chat Session）记住用户的喜好、厌恶、偏好等信息 [1, 2]。这一目标的核心实现逻辑是结合使用**工具（Tools）**来写入记忆，以及**检索上下文（Retrieval Context）**来读取记忆 [1, 3]。

以下是创建一个带记忆功能的 AIP Agent 的详细步骤：

### 1. 建立本体基础（Ontology Setup）
在构建 Agent 之前，必须在**本体管理器（Ontology Manager）**中创建一个用于存储记忆的对象类型 [4]。
*   **创建记忆对象类型：** 创建一个名为“用户记忆（User Memory）”的对象类型 [5]。
*   **配置属性：** 至少需要包含三个关键属性：**Memory ID**（主键）、**User ID**（用于区分不同用户的 ID）以及 **Memory**（存储记忆文本的字符串） [5]。
*   **生成操作（Actions）：** 为该对象类型生成“创建（Create）”操作类型，以便 Agent 能够将新记忆写入系统 [6]。

### 2. 配置 AIP Agent 核心组件
在 AIP Agent Studio 中，通过以下三个部分赋予 Agent 记忆能力：

#### A. 应用状态 (Application State)
应用状态允许 Agent 与其部署的环境（如 Workshop）交换变量 [7]。
*   添加 **User ID 变量**：用于标记当前用户，确保 Agent 在保存记忆时能关联到正确的人 [8, 9]。
*   添加 **记忆对象集变量**：用于在 Workshop 中动态过滤出属于当前用户的记忆记录，并将其传递给 Agent [8]。

#### B. 检索上下文 (Retrieval Context)
这部分决定了 Agent 能够“读取”哪些历史信息 [3]。
*   **本体上下文 (Ontology Context)：** 选择之前创建的“用户记忆”对象类型 [10]。
*   **变量化检索：** 将检索设置配置为“变量（Variable）”，并将其映射到应用状态中的“当前用户记忆对象集”。这样 Agent 每次回复前都会查阅该用户已保存的所有记忆 [10]。

#### C. 工具 (Tools)
*   **应用操作 (Apply Action)：** 添加之前创建的“创建用户记忆”操作工具 [11]。
*   **自动执行：** 开启 **“允许代理自动运行所选操作”** 选项，使用户在说“请记住……”时，Agent 能在后台静默完成写入，无需用户手动点击确认按钮 [12]。

### 3. 提示词工程 (System Prompting)
系统提示词需要明确规定 Agent 何时以及如何操作记忆，以确保准确性并防止幻觉 [13]：
*   **触发条件：** 规定 Agent **仅在用户明确包含“记住（remember）”一词时**才创建新记忆，禁止 Agent 推测或假设用户的意图 [9, 11]。
*   **数据关联：** 指示 Agent 在执行创建操作时，必须使用应用状态中的 `user_id` 参数 [9]。
*   **正当性要求：** 要求 Agent 在运行操作后，必须向用户解释为什么要记录这段信息 [14]。

### 4. 在 Workshop 中部署与集成
Agent 必须部署在 Workshop 中才能发挥完整的动态记忆功能 [15]：
*   **获取用户信息：** 在 Workshop 中通过 **Multipass Attribute** 变量获取当前登录用户的真实 User ID [16]。
*   **动态过滤：** 创建一个对象集变量，通过过滤器筛选出 `User ID == 当前用户 ID` 的记忆对象 [16, 17]。
*   **变量绑定：** 将上述 Workshop 变量映射到 Agent Interactive Widget 的输入参数中 [17]。

### 5. 运行效果示例
*   **写入记忆：** 用户发送消息“请记住我只喜欢沙拉里有菠菜、玉米和豆子”，Agent 会自动触发创建操作，将此偏好保存到本体中 [1, 4]。
*   **读取记忆：** 当用户开启一个**全新的聊天会话**并说“为我准备一份晚餐沙拉食谱”时，Agent 会通过检索上下文读取到之前的偏好，生成的食谱将仅包含用户喜欢的配料 [4, 18]。

通过这种架构，您可以模拟类似 Claude 或 ChatGPT 的记忆功能，使 AI 助手能够根据用户的技术细节水平、内容兴趣或特定业务偏好提供个性化响应 [18]。
