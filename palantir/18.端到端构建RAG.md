在 Palantir Foundry 中，构建一个从 PDF 文档到**检索增强生成 (RAG)** 的端到端工作流，主要涉及使用 **Pipeline Builder** 进行数据处理（提取、切分、向量化）以及使用 **AIP Logic** 构建推理逻辑 [1, 2]。

以下是根据来源整理的详细实施步骤：

### 第一阶段：使用 Pipeline Builder 准备知识库
这一阶段的目标是将非结构化的 PDF 文件转化为本体（Ontology）中带有**嵌入属性（Embedding Property）**的对象 [3-5]。

1.  **数据上传与媒体集创建：**
    *   将 PDF 文件上传至 Foundry，并选择将其保存为**媒体集（Media Set）** [6, 7]。
    *   媒体集是存储 PDF、图片和视频等非结构化数据的专用方式 [8, 9]。
2.  **转换为表格数据：**
    *   在 Pipeline Builder 中，使用 `Convert media set to table rows` 转换插件，将媒体集转化为包含文件路径、媒体引用（Media Reference）和资源 ID（RID）的表格 [3, 10, 11]。
3.  **文本提取（OCR）：**
    *   使用 `PDF text extraction` 转换。对于扫描件或不可直接读取的 PDF，建议使用 **OCR（光学字符识别）** 模式 [12, 13]。
    *   结果通常是一个数组，每个元素对应一页的内容。需使用 `Explode` 操作将每一页展开为独立行，并提取页码信息 [14-16]。
4.  **文本切分（Chunking）：**
    *   使用 `Chunk string` 插件将长文本分解为更小的片段（如 512 个字符/标记） [17, 18]。
    *   **原因：** 切分可以提高检索的相关性并加快向量化速度 [19, 20]。
5.  **生成向量嵌入（Embeddings）：**
    *   使用 `Text to embeddings` 插件。选择一个嵌入模型（如 `text-embedding-3-small`），将文本片段转化为高维空间的数值向量 [4, 5]。
    *   这些向量捕捉了文本的语义，是实现语义搜索的关键 [4, 5]。
6.  **定义主键与输出对象：**
    *   通过连接 RID、页码和切分位置生成唯一 ID [21, 22]。
    *   将输出部署为**对象类型（Object Type）**，并确保在本体管理器中正确配置嵌入属性的模型信息 [23-25]。

### 第二阶段：使用 AIP Logic 构建推理逻辑
一旦知识库对象索引完成，就可以通过 AIP Logic 构建 RAG 函数 [26, 27]。

1.  **定义输入：**
    *   创建一个逻辑函数，接收用户的自然语言查询（如 `user_question`）作为字符串输入 [28, 29]。
2.  **执行语义搜索（检索）：**
    *   添加 **Semantic Search Block**。
    *   配置搜索之前创建的对象集，利用嵌入属性查找与用户问题语义最接近的片段（例如返回前 10 个最相关的片段） [28, 30, 31]。
3.  **数据格式化：**
    *   使用专门的块将检索到的对象集转换为**字符串格式**。这样可以将原始对象属性（如文本内容）拼接起来提供给大模型（LLM）作为上下文 [32, 33]。
4.  **LLM 综合生成（增强生成）：**
    *   添加 **Use LLM Block** [34, 35]。
    *   **系统提示词（System Prompt）：** 赋予 AI 角色（如“研究助手”），并明确指令：“根据提供的研究论文片段，简明扼要地回答用户问题” [34, 35]。
    *   **上下文注入：** 在任务提示词中引用格式化后的语义搜索结果和原始问题变量 [32, 33]。

### 第三阶段：在 Workshop 中交付应用
最后，将构建好的逻辑集成到面向业务用户的应用程序中 [36, 37]。

1.  **添加交互组件：**
    *   在 Workshop 中添加 `Text Input`（文本输入框）供用户提问 [36, 37]。
    *   添加 **AIP Generated Content** 组件，并将其绑定到发布好的 AIP Logic 函数 [38, 39]。
2.  **实现溯源（Citations）：**
    *   （可选）通过配置变量记录用户点击的引用片段，并结合 `PDF Viewer` 组件，让用户点击回答中的来源时，能直接跳转到对应 PDF 的具体页码进行验证 [40, 41]。

### 总结
该流程的核心价值在于：**Pipeline Builder** 负责将非结构化文档转化为机器可理解的语义向量 [4]；**AIP Logic** 通过语义搜索而非关键词匹配来检索事实 [42, 43]；最终通过 **LLM** 将零散的知识片段整合为自然语言答案，从而有效消除模型幻觉 [44, 45]。
