在 Palantir Foundry 中使用 Data Expectations（数据期望） 是一种防止“脏数据”在数据管道中传播的关键机制。通过对输入和输出数据进行断言（Assertions），您可以确保数据的准确性，并在数据质量不达标时阻止构建运行。
根据提供的资料，以下是关于如何在 Foundry 中详细使用 Data Expectations 的指南：
1. 核心理念：为什么要使用 Data Expectations？
使用 Data Expectations 的核心目的是防止不良数据在管道中传播。
• 输入与输出验证：您不仅应该验证输出结果是否正确，还应该验证输入数据是否符合预期的参数。
• “过期”优于“错误”：如果输入数据不正确，构建（Build）根本就不应该运行。虽然这会导致数据变得陈旧（stale），但这比让错误数据传播到下游（如机器学习模型、欺诈检测或市场营销分析）要好得多。一旦错误数据进入下游，发现和修复的时间越长，造成的后果就越严重。
2. 实施步骤：如何在代码库中添加检查
在 Foundry 的代码库（Code Repositories）中，您可以通过以下步骤添加数据期望：
第一步：创建新分支
为了遵循良好的开发实践，不要直接将代码推送到主分支（master）。您应该创建一个新分支（例如命名为 add.expectations）来进行开发和测试。
第二步：编写检查逻辑
您可以使用特定的语法来对列（Columns）进行检查。资料中提供了两个具体的实施案例：
• 案例一：逻辑比较（出发与到达时间） 在处理航班数据时，合乎逻辑的期望是“到达时间”必须晚于“出发时间”。
    ◦ 代码逻辑：选择 departure（出发）列，使用 is before 函数与 arrival（到达）列进行比较。
    ◦ 命名检查：给这个检查起一个有意义的名字，例如 "departure should be before arrival"。
    ◦ 代码示例逻辑：check(departure).is_before(arrival)。
• 案例二：输入数据格式验证（机场代码长度） 您可以直接检查输入数据集（Input），而不仅仅是当前数据集。例如，检查作为输入的 origin（始发地）机场代码是否正好是3个字符。
    ◦ 代码逻辑：针对输入数据集的列进行验证。
    ◦ 注意数据类型：资料中提到，使用 .size() 函数检查字符串长度会导致构建失败，因为该函数通常用于数组或映射（Arrays or Maps）。
    ◦ 修正方法：对于字符串长度检查，可以使用正则表达式（Regex）。通过自动完成功能找到类似 rlike 的函数，编写正则表达式来验证是否包含三个连续字符。
3. 测试与预览 (Preview & Build)
在提交全面构建之前，Foundry 提供了预览和测试机制：
• 预览模式 (Preview Mode)： 在编写好检查后，可以运行预览。预览通常只会对数据的快照（例如 1000 行）进行检查。
    ◦ 如果有数据不符合期望，预览会显示失败，并给出具体的错误样本（例如：到达时间比出发时间早了一天）。这能帮助开发者快速发现逻辑或数据问题。
• 全面构建 (Full Build)： 运行全面构建会检查所有数据（例如 400 万行）。构建完成后，系统会报告有多少行数据未通过检查（例如 200,000 行失败）。
4. 设定失败策略：报错还是警告？
开发者可以决定当数据不符合期望时，管道应该如何反应：
• 终止构建 (Fail the Build)：这是默认且推荐的做法。如果检查未通过，构建将失败。这能在 Data Health 视图中看到红色的失败条，从而有效阻止不良数据向下游传播。
• 仅警告 (Warning)：您也可以配置检查，使其在失败时仅发出警告而不终止构建（"just warn us if it's wrong"）。
总结
通过在 Palantir Foundry 中使用 Data Expectations，您可以在 UI 层或管道代码中通过简单的语法（如 check、is_before、rlike）建立数据质量防火墙。这确保了只有符合质量标准的数据才能被下游的业务流程或模型所使用。